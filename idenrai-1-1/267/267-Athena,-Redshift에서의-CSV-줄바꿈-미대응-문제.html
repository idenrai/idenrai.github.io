
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>Athena, Redshift에서의 CSV 줄바꿈 미대응 문제</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">Athena, Redshift에서의 CSV 줄바꿈 미대응 문제</h2>
                                <div class="box-info">
                                    <p class="category">Tech/AWS for Data Engineering</p>
                                    <p class="date">2022-10-20 18:24:31</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p data-ke-size="size16">현재 아래의 동작을 검증 중이다.</p>
<ol style="list-style-type: decimal;" data-ke-list-type="decimal">
<li>KMS 커스토머 관리 키 생성 및 Glue Data Catalog 암호화</li>
<li>KMS키로 암호화한 S3 Bucket에 원본 데이터 투입</li>
<li>Glue Jobs로 데이터 조작 및 클렌징</li>
<li>결과물을 암호화한 다른 Bucket에 격납</li>
<li>Glue Crawler로 결과물 긁어와서&nbsp;Glue Data Catalog에 투입</li>
<li>Data Catalog에 생성된 테이블의 데이터를 Athena로 확인</li>
<li>데이터가 정상적으로 확인되면 Redshift 경유로 Tableau에 연결</li>
</ol>
<p data-ke-size="size16">JSON형식의 뉴스 기사를 CSV로 출력하여 크롤러로 긁어서 6까지 왔는데...</p>
<p data-ke-size="size16">아테나가 뉴스 본문의 줄바꿈에 대응을 해주지 않고, 그냥 데이터 한줄씩 땡겨버리드라.</p>
<p data-ke-size="size16">이게 아테나만 그런거면 그냥 무시해도 되는데, 7도 마찬가지다.</p>
<p data-ke-size="size16">아무래도 그냥 공통적으로 그런거같으니, 일단 아테나에서 잘 돌아가면 다른데서도 잘 돌아갈 듯.</p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">검색해보니 아래와 같은 느낌.</p>
<p data-ke-size="size16"><a href="https://repost.aws/questions/QUwL_lVp85TPe-i3VP6jcU_A/athena-not-able-to-read-multi-line-text-in-csv-fields" target="_blank" rel="noopener">https://repost.aws/questions/QUwL_lVp85TPe-i3VP6jcU_A/athena-not-able-to-read-multi-line-text-in-csv-fields</a></p>
<figure id="og_1666257579946" contenteditable="false" data-ke-type="opengraph" data-ke-align="alignCenter" data-og-type="website" data-og-title="Athena not able to read multi-line text in CSV fields | AWS re:Post" data-og-description="I've this CSV content file &quot;one&quot;,&quot;two&quot;,&quot;three&quot;,&quot;four&quot;,&quot;five&quot;,&quot;six&quot;,&quot;seven&quot;,&quot;eight&quot;,&quot;nine&quot;,&quot;ten&quot; &quot;one&quot;,&quot;two&quot;,&quot;three&quot;,&quot;four&quot;,&quot;five \&quot; quote \&quot; five2&quot;,&quot;six&quot;,&quot;seven&quot;,&quot;eight&quot;,&quot;nine&quot;,&quot;ten&quot; &quot;one&quot;,&quot;two&quot;..." data-og-host="repost.aws" data-og-source-url="https://repost.aws/questions/QUwL_lVp85TPe-i3VP6jcU_A/athena-not-able-to-read-multi-line-text-in-csv-fields" data-og-url="https://repost.aws/questions/QUwL_lVp85TPe-i3VP6jcU_A/athena-not-able-to-read-multi-line-text-in-csv-fields" data-og-image="https://scrap.kakaocdn.net/dn/hBzTh/hyQav2uiWD/PkeRwAtSnJZ5LGiOFpKn7K/img.png?width=1200&amp;height=630&amp;face=0_0_1200_630"><a href="https://repost.aws/questions/QUwL_lVp85TPe-i3VP6jcU_A/athena-not-able-to-read-multi-line-text-in-csv-fields" target="_blank" rel="noopener" data-source-url="https://repost.aws/questions/QUwL_lVp85TPe-i3VP6jcU_A/athena-not-able-to-read-multi-line-text-in-csv-fields">
<div class="og-image" style="background-image: url('https://scrap.kakaocdn.net/dn/hBzTh/hyQav2uiWD/PkeRwAtSnJZ5LGiOFpKn7K/img.png?width=1200&amp;height=630&amp;face=0_0_1200_630');">&nbsp;</div>
<div class="og-text">
<p class="og-title" data-ke-size="size16">Athena not able to read multi-line text in CSV fields | AWS re:Post</p>
<p class="og-desc" data-ke-size="size16">I've this CSV content file "one","two","three","four","five","six","seven","eight","nine","ten" "one","two","three","four","five \" quote \" five2","six","seven","eight","nine","ten" "one","two"...</p>
<p class="og-host" data-ke-size="size16">repost.aws</p>
</div>
</a></figure>
<p data-ke-size="size16">아테나는 CSV에 그런거 안해주니까 그냥 Parquet으로 하랜다.</p>
<p data-ke-size="size16"><a href="https://yohei-a.hatenablog.jp/entry/20191015/1571066002" target="_blank" rel="noopener">https://yohei-a.hatenablog.jp/entry/20191015/1571066002</a></p>
<figure id="og_1666257747578" contenteditable="false" data-ke-type="opengraph" data-ke-align="alignCenter" data-og-type="article" data-og-title="Athena で改行を含む CSV を扱いたい場合は Glue ジョブで Parquet に変換する - ablog" data-og-description="データの中身に改行を含む CSV を Athena でクエリすると正しく扱えなかったが、Glue ジョブで CSV を Parquet に変換すると改行を含むデータを扱うことができた。おそらく OpenCSVSerDe は改行に対応" data-og-host="yohei-a.hatenablog.jp" data-og-source-url="https://yohei-a.hatenablog.jp/entry/20191015/1571066002" data-og-url="https://yohei-a.hatenablog.jp/entry/20191015/1571066002" data-og-image="https://scrap.kakaocdn.net/dn/bKhQ8u/hyQbvugU8k/2o768KfLaTEZDGlaP9cpek/img.png?width=1200&amp;height=764&amp;face=0_0_1200_764,https://scrap.kakaocdn.net/dn/QwHlJ/hyQbAPSXXz/XGTphj21s83TeXi7Jic3yk/img.png?width=1200&amp;height=764&amp;face=0_0_1200_764,https://scrap.kakaocdn.net/dn/cZK2uQ/hyQauP3thx/mmfNi2BrGF990p30LJ86SK/img.png?width=1200&amp;height=975&amp;face=0_0_1200_975"><a href="https://yohei-a.hatenablog.jp/entry/20191015/1571066002" target="_blank" rel="noopener" data-source-url="https://yohei-a.hatenablog.jp/entry/20191015/1571066002">
<div class="og-image" style="background-image: url('https://scrap.kakaocdn.net/dn/bKhQ8u/hyQbvugU8k/2o768KfLaTEZDGlaP9cpek/img.png?width=1200&amp;height=764&amp;face=0_0_1200_764,https://scrap.kakaocdn.net/dn/QwHlJ/hyQbAPSXXz/XGTphj21s83TeXi7Jic3yk/img.png?width=1200&amp;height=764&amp;face=0_0_1200_764,https://scrap.kakaocdn.net/dn/cZK2uQ/hyQauP3thx/mmfNi2BrGF990p30LJ86SK/img.png?width=1200&amp;height=975&amp;face=0_0_1200_975');">&nbsp;</div>
<div class="og-text">
<p class="og-title" data-ke-size="size16">Athena で改行を含む CSV を扱いたい場合は Glue ジョブで Parquet に変換する - ablog</p>
<p class="og-desc" data-ke-size="size16">データの中身に改行を含む CSV を Athena でクエリすると正しく扱えなかったが、Glue ジョブで CSV を Parquet に変換すると改行を含むデータを扱うことができた。おそらく OpenCSVSerDe は改行に対応</p>
<p class="og-host" data-ke-size="size16">yohei-a.hatenablog.jp</p>
</div>
</a></figure>
<p data-ke-size="size16">마침 나도 출력 데이터의 형식은 상관없고, 그냥 Data Catalog에서만 잘 인식되면 되니까, Glue Job에서 Parquet으로 출력해버렸다.</p>
<pre id="code_1666257723865" class="python" data-ke-language="python" data-ke-type="codeblock"><code>S3bucket_node3 = glueContext.write_dynamic_frame.from_options(
    frame=ApplyMapping_node2,
    connection_type="s3",
    format="glueparquet",
    connection_options={
        "path": "s3://output/news/",
        "partitionKeys": [],
    },
    format_options={"compression": "snappy"},
    transformation_ctx="S3bucket_node3",
)</code></pre>
<p data-ke-size="size16">크롤러로 다시 긁어서, Athena와 Redshift, Tableau로 확인해보니 잘 돌아간다.</p>
                        </div>
                        <br/>
                        <div class="tags">
                            #CSV #tableau #athena #multiline #redshift #Parquet #Glue Data Catalog 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
