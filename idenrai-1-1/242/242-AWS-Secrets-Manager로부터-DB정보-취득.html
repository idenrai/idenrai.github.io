
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>AWS Secrets Manager로부터 DB정보 취득</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">AWS Secrets Manager로부터 DB정보 취득</h2>
                                <div class="box-info">
                                    <p class="category">Tech/JavaScript</p>
                                    <p class="date">2021-05-28 11:39:13</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p data-ke-size="size16">AWS DocumentDB의 정보 보관을 위해 AWS Secrets Manager를 사용하게 되었다.<br />SecretsManager의 정보 자체는 Lambda의 환경변수로 아래와 같이 설정하면 된다.<br /><br /></p>
<p><figure class="imageblock alignCenter" data-origin-width="1547" data-origin-height="822" data-filename="Lambda_환경변수.png" data-ke-mobilestyle="widthOrigin">
    <span data-lightbox="lightbox">
        <img src="./img/img.png" data-origin-width="1547" data-origin-height="822" data-filename="Lambda_환경변수.png" data-ke-mobilestyle="widthOrigin" />
    </span>
    <figcaption>Lambda 환경변수 설정</figcaption>
</figure></p>
<p data-ke-size="size16">현재 Lambda를 Serverless를 써서 올리기로 하고 그냥 다 코드 자체는 로컬에서 작성하고 있기 때문에, 사실 테스트를 하려면 그냥 env같은거 만들어서 정보 다 넣어두고 쓰면 되지만서도, Secrets Manager를 한번은 테스트 하고 싶으니까 Credential까지 넣어서 한번 적어 봤다.</p>
<pre id="code_1622169233949" class="javascript" data-ke-language="javascript" data-ke-type="codeblock"><code>import * as aws from 'aws-sdk';
import { DatabaseInfoModel } from '../models/DatabaseInfoModel';

export default async function (): Promise&lt;DatabaseInfoModel&gt; {
  const secretId = {
    SecretId: process.env.SECRET_ID // Lambda에서 사용시엔 환경변수 등록
  }
  const info = {
    region: process.env.AWS_REGION, // Lambda에선 기본 취득 가능
    credentials: {
      accessKeyId: process.env.ACCESS_KEY, // Lambda에서 구동시엔 필요없음
      secretAccessKey: process.env.SECRET_KEY // Lambda에서 구동시엔 필요없음
    }
  }
  return new Promise((resolve, reject) =&gt; {
    new aws.SecretsManager(info).getSecretValue(secretId, (err, data) =&gt; {
      if (err) {
        reject(err);
      } else {
        const res = JSON.parse(data.SecretString);
        const dbInfo = new DatabaseInfoModel();
        dbInfo.username = res.username;
        dbInfo.password = res.password;
        dbInfo.host = res.host;
        dbInfo.port = res.port;
        dbInfo.ssl = res.ssl;
        resolve(dbInfo);
      }
    });
  });
}
</code></pre>
<p data-ke-size="size16">취득할 수 있는 Secret의 형태는 아래와 같다.</p>
<pre id="code_1622169527744" class="javascript" style="display: block; overflow: auto; padding: 20px; color: #383a42; background: #f8f8f8; font-size: 14px; font-family: 'SF Mono', Menlo, Consolas, Monaco, monospace; border: 1px solid #ebebeb; line-height: 1.71; margin: 20px auto 0px; cursor: default; z-index: 1; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;" data-ke-language="javascript" data-ke-type="codeblock"><code>{
  username: 'xxx', // DB UserId
  password: 'xxxxxxxx', // DB PW
  engine: 'mongo',
  host: 'xxxx-xxxxx.com', // DB URL
  port: 12345,
  ssl: true,
  dbClusterIdentifier: 'xxxxx'
}</code></pre>
<p data-ke-size="size16">타입스크립트를 쓴다면 클래스도 만들어 줄 것.</p>
<pre id="code_1623218862967" class="javascript" data-ke-language="javascript" data-ke-type="codeblock"><code>import * as v from "class-validator";

export class DatabaseInfoModel {
  constructor() { }

  // DocumentDB접속시에 필요한 정보만 일단 NotEmpty걸어두기
  @v.IsNotEmpty()
  username: string
  @v.IsNotEmpty()
  password: string
  @v.IsNotEmpty()
  host: string
  @v.IsNotEmpty()
  port: number
  @v.IsNotEmpty()
  ssl: boolean

  engine: string
  dbClusterIdentifier: string
}</code></pre>
<p data-ke-size="size16">사용시엔 아래와 같이 사용하면 된다.</p>
<pre id="code_1623219036582" class="javascript" style="display: block; overflow: auto; padding: 20px; color: #383a42; background: #f8f8f8; font-size: 14px; font-family: 'SF Mono', Menlo, Consolas, Monaco, monospace; border: 1px solid #ebebeb; line-height: 1.71; margin: 20px auto 0px; cursor: default; z-index: 1; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;" data-ke-language="javascript" data-ke-type="codeblock"><code>...
const databaseInfo: DatabaseInfoModel = await getDatabaseInfo().catch(error =&gt; {
  throw error;
});

// DocumentDB URL
const url = `mongodb://${databaseInfo.username}:${databaseInfo.password}@${databaseInfo.host}:${databaseInfo.port}/?ssl=${databaseInfo.ssl}`;</code></pre>
<p data-ke-size="size16">DocumentDB 접속 관련은 아래를 참조.</p>
<p data-ke-size="size16"><a href="https://idenrai.tistory.com/243" target="_blank" rel="noopener">https://idenrai.tistory.com/243</a></p>
                        </div>
                        <br/>
                        <div class="tags">
                            #typescript #AWS Secrets Manager #documentdb 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
