
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>BigDecimal Divide의 정밀도 설정 문제</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">BigDecimal Divide의 정밀도 설정 문제</h2>
                                <div class="box-info">
                                    <p class="category">Tech/Java</p>
                                    <p class="date">2016-04-01 10:00:14</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p><b>以前のコード</b></p><div class="colorscripter-code" style="color:#010101; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; position:relative !important; overflow:auto"><table class="colorscripter-code-table" style="margin:0; padding:0; border:none; background-color:#fafafa; border-radius:4px;" cellspacing="0" cellpadding="0"><tbody><tr><td style="padding:6px; border-right:2px solid #e5e5e5"><div style="margin:0; padding:0; word-break:normal; text-align:right; color:#666; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; line-height:130%"><div style="line-height:130%">1</div><div style="line-height:130%">2</div><div style="line-height:130%">3</div><div style="line-height:130%">4</div><div style="line-height:130%">5</div><div style="line-height:130%">6</div><div style="line-height:130%">7</div><div style="line-height:130%">8</div><div style="line-height:130%">9</div><div style="line-height:130%">10</div><div style="line-height:130%">11</div></div></td><td style="padding:6px 0"><div style="margin:0; padding:0; color:#010101; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; line-height:130%"><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{mnKosoku}).divide(</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{nuTaxRate})</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;.multiply(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal(<span style="color:#63a35c">"100"</span>))</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;.<span style="color:#066de2">add</span>(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal(<span style="color:#63a35c">"100"</span>)<span style="line-height: 130%;">)</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="line-height: 130%;">,&nbsp;</span><span style="line-height: 130%; color: rgb(0, 153, 204);">2</span><span style="line-height: 130%;">,&nbsp;RoundingMode.HALF_UP)</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">.multiply(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{nuTaxRate})</div><div style="padding:0 6px; white-space:pre; line-height:130%">.multiply(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal(<span style="color:#63a35c">"100"</span>)))</div><div style="padding:0 6px; white-space:pre; line-height:130%">.setScale(<span style="color:#0099cc">0</span>,</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;($F{stShohizeiHasushori}.<span style="color:#066de2">equals</span>(<span style="color:#63a35c">"1"</span>)&nbsp;?&nbsp;BigDecimal.ROUND_HALF_UP&nbsp;:&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;($F{stShohizeiHasushori}.<span style="color:#066de2">equals</span>(<span style="color:#63a35c">"2"</span>)&nbsp;?&nbsp;BigDecimal.ROUND_UP&nbsp;:&nbsp;BigDecimal.ROUND_DOWN))</div><div style="padding:0 6px; white-space:pre; line-height:130%">)</div></div><div style="text-align:right; margin-top:-13px; margin-right:5px; font-size:9px; font-style:italic"><a href="http://colorscripter.com/info#e" target="_blank" style="color: rgb(229, 229, 229);">Colored by Color Scripter</a></div></td><td style="vertical-align:bottom; padding:0 2px 4px 0"><span style="color: white; font-size: 9px; word-break: normal; border-radius: 10px; padding: 1px; background-color: rgb(229, 229, 229);"><a href="http://colorscripter.com/info#e" target="_blank" style="color: white;">cs</a><br /><br /></span></td></tr></tbody></table></div><p><br /></p><p><b>修正したコード</b></p><p><br /></p><div class="colorscripter-code" style="color:#010101; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; position:relative !important; overflow:auto"><table class="colorscripter-code-table" style="margin:0; padding:0; border:none; background-color:#fafafa; border-radius:4px;" cellspacing="0" cellpadding="0"><tbody><tr><td style="padding:6px; border-right:2px solid #e5e5e5"><div style="margin:0; padding:0; word-break:normal; text-align:right; color:#666; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; line-height:130%"><div style="line-height:130%">1</div><div style="line-height:130%">2</div><div style="line-height:130%">3</div><div style="line-height:130%">4</div><div style="line-height:130%">5</div><div style="line-height:130%">6</div><div style="line-height:130%">7</div><div style="line-height:130%">8</div><div style="line-height:130%">9</div><div style="line-height:130%">10</div></div></td><td style="padding:6px 0"><div style="margin:0; padding:0; color:#010101; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; line-height:130%"><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{mnKosoku}).divide(</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{nuTaxRate})</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;.multiply(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal(<span style="color:#63a35c">"100"</span>))</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;.<span style="color:#066de2">add</span>(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal(<span style="color:#63a35c">"100"</span>))</div><div style="padding:0 6px; white-space:pre; line-height:130%">,&nbsp;MathContext.DECIMAL32)</div><div style="padding:0 6px; white-space:pre; line-height:130%">.multiply(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{nuTaxRate}).multiply(<span style="color:#a71d5d">new</span>&nbsp;BigDecimal(<span style="color:#63a35c">"100"</span>)))</div><div style="padding:0 6px; white-space:pre; line-height:130%">.setScale(<span style="color:#0099cc">0</span>,</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;($F{stShohizeiHasushori}.<span style="color:#066de2">equals</span>(<span style="color:#63a35c">"1"</span>)&nbsp;?&nbsp;BigDecimal.ROUND_HALF_UP&nbsp;:</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;($F{stShohizeiHasushori}.<span style="color:#066de2">equals</span>(<span style="color:#63a35c">"2"</span>)&nbsp;?&nbsp;BigDecimal.ROUND_UP&nbsp;:&nbsp;BigDecimal.ROUND_DOWN))</div><div style="padding:0 6px; white-space:pre; line-height:130%">)</div></div><div style="text-align:right; margin-top:-13px; margin-right:5px; font-size:9px; font-style:italic"><a href="http://colorscripter.com/info#e" target="_blank" style="color: rgb(229, 229, 229);">Colored by Color Scripter</a></div></td><td style="vertical-align:bottom; padding:0 2px 4px 0"><a href="http://colorscripter.com/info#e" target="_blank" style="color: white;"><span style="font-size: 9px; word-break: normal; border-radius: 10px; padding: 1px; background-color: rgb(229, 229, 229);">cs</span></a></td></tr></tbody></table></div><p><br /></p><p>ここで問題となったのは、</p><p><br /></p><div class="colorscripter-code" style="color:#010101; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; position:relative !important; overflow:auto"><table class="colorscripter-code-table" style="margin:0; padding:0; border:none; background-color:#fafafa; border-radius:4px;" cellspacing="0" cellpadding="0"><tbody><tr><td style="padding:6px; border-right:2px solid #e5e5e5"><div style="margin:0; padding:0; word-break:normal; text-align:right; color:#666; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; line-height:130%"><div style="line-height:130%">1</div><div style="line-height:130%">2</div><div style="line-height:130%">3</div></div></td><td style="padding:6px 0"><div style="margin:0; padding:0; color:#010101; font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; line-height:130%"><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#a71d5d">new</span>&nbsp;BigDecimal($F{mnKosoku}).divide(</div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#999999">//&nbsp;…</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">,&nbsp;MathContext.DECIMAL32)</div></div></td><td style="vertical-align:bottom; padding:0 2px 4px 0"><a href="http://colorscripter.com/info#e" target="_blank" style="color: white;"><span style="font-size: 9px; word-break: normal; border-radius: 10px; padding: 1px; background-color: rgb(229, 229, 229);">cs</span></a></td></tr></tbody></table></div><p><br /></p><p>この部分の「divide」の精密度の問題だった。</p><p>今までのコードでは精密度を小数点２桁までに設定してdivideをけたが、</p><p>これだと端数処理をする直前の小数点は2桁となる。</p><p><br /></p><p>例として、</p><p>高速料：50000</p><p>税率　：0.08</p><p>として計算すると</p><p><br /></p><p>元々は</p><p>(50000/((0.08*100)+100))*(0.08*100)</p><p>=(462.962962962...)*8</p><p>=3703.70370370370...</p><p>になるが、</p><p><br /></p><p>これだと(50000/108)のところで小数点二桁になって</p><p>(50000/((0.08*100)+100))*(0.08*100)</p><p>=(462.96)*8</p><p>=3703.68</p><p>となってしまう。</p><p><br /></p><p>切り捨てや切り上げの場合の危険性は少ないが、</p><p>四捨五入の場合は値の変更可能性は高くなる。</p><p><br /></p><p>それで今回その小数点の桁数を</p><p>MathContext.DECIMAL32 (小数点6桁まで)</p><p>に修正。</p><p><br /></p><p>これだと(50000/108)のところで小数点二桁になって</p><p>(50000/((0.08*100)+100))*(0.08*100)</p><p>=(462.962963)*8</p><p>=3703.703704</p><p>となる。</p><p>ここからの四捨五入だと、数値の変更は難しい。</p><p><br /></p><p><b>参考</b></p><p><a href="http://blog.naver.com/dlrudwjs/110038915693" target="_blank" class="tx-link">java.math.BigDecimal의 바른 사용에 대해서-2</a></p>
                        </div>
                        <br/>
                        <div class="tags">
                            #java #BigDecimal #divide 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
