---
import { getCollection } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import { formatDate } from '../../utils/date';

const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// tags[0] = ëŒ€ë¶„ë¥˜, tags[1] = ì†Œë¶„ë¥˜
const mainCats = [...new Set(allPosts.map((p) => p.data.tags[0]).filter(Boolean))];
---

<PageLayout title="ë¸”ë¡œê·¸" description="ê°œë°œí•˜ë©´ì„œ ë°°ìš´ ê²ƒë“¤ì„ ê¸°ë¡í•©ë‹ˆë‹¤.">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 py-12">

    <div class="flex items-end justify-between mb-8">
      <div>
        <h1 class="text-3xl font-extrabold text-gray-900 dark:text-gray-50 mb-2">ë¸”ë¡œê·¸</h1>
        <p class="text-gray-500 dark:text-gray-500 text-sm">
          ì´ <span id="post-count">{allPosts.length}</span>ê°œì˜ ê¸€
        </p>
      </div>
    </div>

    <!-- ëŒ€ë¶„ë¥˜ í•„í„° -->
    <div class="flex flex-wrap gap-2 mb-3" id="main-cats">
      <button
        data-main=""
        class="cat-btn cat-main active px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-accent-600 text-white"
      >
        ì „ì²´ ({allPosts.length})
      </button>
      {mainCats.map((cat) => {
        const count = allPosts.filter((p) => p.data.tags[0] === cat).length;
        return (
          <button
            data-main={cat}
            class="cat-btn cat-main px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700"
          >
            {cat} ({count})
          </button>
        );
      })}
    </div>

    <!-- ì†Œë¶„ë¥˜ í•„í„° (ëŒ€ë¶„ë¥˜ ì„ íƒ ì‹œ í‘œì‹œ) -->
    <div id="sub-cats" class="hidden flex-wrap gap-2 mb-8 pl-1 border-l-2 border-accent-400/50">
      <!-- JSë¡œ ë™ì  ìƒì„± -->
    </div>

    <!-- í¬ìŠ¤íŠ¸ ëª©ë¡ -->
    <div class="grid gap-4" id="post-list">
      {allPosts.map((post) => {
        const mainCat = post.data.tags[0] ?? '';
        const subCat = post.data.tags[1] ?? '';
        return (
          <article
            class="post-item card group"
            data-main={mainCat}
            data-sub={subCat}
          >
            <a href={`/blog/${post.slug}`} class="block">
              <div class="flex flex-wrap gap-2 mb-3">
                {mainCat && <span class="tag-badge">{mainCat}</span>}
                {subCat && <span class="tag-badge opacity-75">{subCat}</span>}
              </div>
              <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100 group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors leading-snug mb-2">
                {post.data.title}
              </h2>
              {post.data.description && (
                <p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed line-clamp-2 mb-4">
                  {post.data.description}
                </p>
              )}
              <time datetime={post.data.date.toISOString()} class="text-xs text-gray-400 dark:text-gray-600">
                {formatDate(post.data.date)}
              </time>
            </a>
          </article>
        );
      })}
    </div>

    <!-- ê²°ê³¼ ì—†ìŒ -->
    <div id="empty-state" class="hidden text-center py-20 text-gray-400 dark:text-gray-600">
      <p class="text-4xl mb-4">ğŸ”</p>
      <p>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

  </div>
</PageLayout>

<script>
  // í¬ìŠ¤íŠ¸ ë°ì´í„° ìˆ˜ì§‘
  const posts = Array.from(document.querySelectorAll<HTMLElement>('.post-item'));
  const postList = document.getElementById('post-list')!;
  const emptyState = document.getElementById('empty-state')!;
  const postCount = document.getElementById('post-count')!;
  const subCatsEl = document.getElementById('sub-cats')!;

  let selectedMain = '';
  let selectedSub = '';

  // ì†Œë¶„ë¥˜ ë²„íŠ¼ ìƒì„±
  function buildSubCats(main: string) {
    const subs = [...new Set(
      posts
        .filter(p => p.dataset.main === main && p.dataset.sub)
        .map(p => p.dataset.sub!)
    )].sort();

    if (subs.length === 0) {
      subCatsEl.classList.add('hidden');
      subCatsEl.classList.remove('flex');
      return;
    }

    const allCount = posts.filter(p => p.dataset.main === main).length;
    subCatsEl.innerHTML = `
      <button data-sub="" class="cat-btn cat-sub active px-2.5 py-1 rounded-md text-xs font-medium transition-colors bg-accent-100 dark:bg-accent-900/40 text-accent-800 dark:text-accent-300">
        ì „ì²´ (${allCount})
      </button>
      ${subs.map(sub => {
        const count = posts.filter(p => p.dataset.main === main && p.dataset.sub === sub).length;
        return `<button data-sub="${sub}" class="cat-btn cat-sub px-2.5 py-1 rounded-md text-xs font-medium transition-colors bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">${sub} (${count})</button>`;
      }).join('')}
    `;

    subCatsEl.classList.remove('hidden');
    subCatsEl.classList.add('flex');

    // ì†Œë¶„ë¥˜ ì´ë²¤íŠ¸ ë“±ë¡
    subCatsEl.querySelectorAll<HTMLButtonElement>('.cat-sub').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedSub = btn.dataset.sub ?? '';
        updateSubActive();
        applyFilter();
      });
    });
  }

  function updateMainActive() {
    document.querySelectorAll<HTMLButtonElement>('.cat-main').forEach(btn => {
      const isActive = btn.dataset.main === selectedMain;
      btn.className = `cat-btn cat-main px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
        isActive
          ? 'bg-accent-600 text-white'
          : 'bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700'
      }`;
    });
  }

  function updateSubActive() {
    subCatsEl.querySelectorAll<HTMLButtonElement>('.cat-sub').forEach(btn => {
      const isActive = btn.dataset.sub === selectedSub;
      btn.className = `cat-btn cat-sub px-2.5 py-1 rounded-md text-xs font-medium transition-colors ${
        isActive
          ? 'bg-accent-100 dark:bg-accent-900/40 text-accent-800 dark:text-accent-300'
          : 'bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700'
      }`;
    });
  }

  function applyFilter() {
    let visible = 0;
    posts.forEach(post => {
      const matchMain = !selectedMain || post.dataset.main === selectedMain;
      const matchSub = !selectedSub || post.dataset.sub === selectedSub;
      const show = matchMain && matchSub;
      post.classList.toggle('hidden', !show);
      if (show) visible++;
    });
    postCount.textContent = String(visible);
    emptyState.classList.toggle('hidden', visible > 0);
    postList.classList.toggle('hidden', visible === 0);
  }

  // ëŒ€ë¶„ë¥˜ ì´ë²¤íŠ¸
  document.querySelectorAll<HTMLButtonElement>('.cat-main').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedMain = btn.dataset.main ?? '';
      selectedSub = '';
      updateMainActive();
      if (selectedMain) {
        buildSubCats(selectedMain);
      } else {
        subCatsEl.classList.add('hidden');
        subCatsEl.classList.remove('flex');
      }
      applyFilter();
    });
  });
</script>
