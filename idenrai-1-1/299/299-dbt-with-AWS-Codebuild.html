
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>dbt with AWS Codebuild</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">dbt with AWS Codebuild</h2>
                                <div class="box-info">
                                    <p class="category">Tech/AWS for Data Engineering</p>
                                    <p class="date">2024-12-18 11:27:31</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p data-ke-size="size16">:::note info<br />수년전 회사 블로그에 적었던 내용을 적당히 클렌징 및 한국어로 번역해서 올림<br />:::</p>
<h2 data-ke-size="size26">개요</h2>
<p data-ke-size="size16">AWS Codebuild 를 이용하여, Git 상의 dbt project 를 스케줄 실행하는 방법을 간단히 검증</p>
<h2 data-ke-size="size26">상세</h2>
<p data-ke-size="size16">아래의 순서로 실시</p>
<ol style="list-style-type: decimal;" data-ke-list-type="decimal">
<li>AWS CodeBuild 로 빌드 프로젝트를 만들어, buildspec.yml 파일 작성</li>
<li>AWS EventBridge 로 빌드 스케줄 설정</li>
</ol>
<h3 data-ke-size="size23">AWS CodeBuild 로 빌드 프로젝트를 만들어, buildspec.yml 파일 작성</h3>
<h4 data-ke-size="size20">작업 순서</h4>
<p data-ke-size="size16">AWS CodeBuild 에서 빌드 프로젝트 작성</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">OAuth 로 Github 연결</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_1.png"  />
    </span>
    <figcaption></figcaption>
</figure><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_2.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">Github 에 연결이 되면, 아래와 같이 리포지토리 설정이 가능</p>
<p data-ke-size="size16"><a href="https://qiita.com/takuma-jpn/items/589593a12e1c3dfd2b45">AWS CodeBuildでBitBucketの特定ブランチからソースを読み込む方法</a></p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_3.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">계속해서 설정</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_4.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">buildspec 을 둘 장소를 지정하기</p>
<p data-ke-size="size16"><code>buildspec.yml</code> 의 내용은 아래와 같이 설정한다</p>
<pre class="vim"><code>version: 0.2
phases:
  install:
    runtime-versions:
      python: 3.9
  pre_build:
    commands:
      - aws --version
      - echo 'region - ' - $AWS_DEFAULT_REGION
      - echo 'repository - ' $REPOSITORY_URI
  build:
    commands:
      - pip install dbt-core dbt-athena-community
      - cd ./Dev/dbt_schedule_sample
      - dbt run --profiles-dir .</code></pre>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_5.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">이걸로 OK</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_6.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">자동으로 만들어진 IAM 롤에 대해선 아래의 권한 부여를 실시</p>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>Lake Formation</li>
<li>Athena</li>
</ul>
<h4 data-ke-size="size20">결과</h4>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_7.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">Athena 확인</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_8.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<h4 data-ke-size="size20">Try &amp; Error</h4>
<p data-ke-size="size16"><b>런타임 문제</b></p>
<p data-ke-size="size16">Python Version 이 <code>3.9</code> 였던 모양으로, <code>buildspec.yml</code> 에서 <code>runtime-versions</code> 를 지정하여 해결</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_9.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16"><b>경로 문제</b></p>
<p data-ke-size="size16">dbt project가 아니라는 소리를 들음<br />디렉토리 변경이 필요했기에, <code>buildspec.yml</code> 에서 <code>cd ./Dev/dbt_schedule_sample</code> 로 폴더 이동을 하여 해결</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_10.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16"><b>profiles.yml 을 찾을 수 없음</b></p>
<p data-ke-size="size16"><code>profiles.yml</code> 을 찾을 수 없었다<br /><code>buildspec.yml</code> 에서 <code>--profiles-dir</code> 을 사용하여, dbt project 내의 <code>profiles.yml</code> 의 장소를 지정하여 해결</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_11.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<h3 data-ke-size="size23">AWS EventBridge 로 빌드 스케줄 설정</h3>
<h4 data-ke-size="size20">작업 순서</h4>
<p data-ke-size="size16">CodeBuild 에서의 dbt 실행이 검증되었으므로, 매일 갱신되는 원 데이터에 맞추어 dbt 도 일 단위 스케줄을 설정<br />EventBridge 에서 스케줄을 작성</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_12.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">원 데이터를 취득하는 Lambda 가 매일 0시에 기동하므로, 이쪽은 여유를 두고 2시로 설정</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_13.png"  />
    </span>
    <figcaption></figcaption>
</figure><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_14.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">타겟 설정에서 CodeBuild 를 지정</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_15.png"  />
    </span>
    <figcaption></figcaption>
</figure><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_16.png"  />
    </span>
    <figcaption></figcaption>
</figure><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_17.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<h4 data-ke-size="size20">결과</h4>
<p data-ke-size="size16">다음날 확인해 보니 제대로 기동하였음</p>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_18.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
<h2 data-ke-size="size26">결론</h2>
<h3 data-ke-size="size23">헤맸던 부분</h3>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><code>profiles.yml</code> 의 설정 부분에서 꽤 고통스러웠음. 다들 보통은 Docker 를 사용하고 있어서 참조할 곳도 없고...</li>
</ul>
<h3 data-ke-size="size23">좋았던 점</h3>
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li>dbt 와 AWS 만 있으면 간단히 ETL 작업 가능</li>
<li>CodeBuild 의 기동 타이밍을 지정할 수 있으므로 유용하게 사용 가능할 듯</li>
<li>이번엔 스케줄 지정이 목적이었기에 이런 느낌이었지만, 실전에서 사용할 때엔 아래와 같이 <code>Step Function</code>에서 돌리는 등으로도 사용 가능</li>
</ul>
<p><figure class="imageblock alignCenter" >
    <span data-lightbox="lightbox">
        <img src="./img/img_19.png"  />
    </span>
    <figcaption></figcaption>
</figure></p>
                        </div>
                        <br/>
                        <div class="tags">
                            #DBT #codebuild 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
