
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>Lambda의 6MB 제한 해결</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">Lambda의 6MB 제한 해결</h2>
                                <div class="box-info">
                                    <p class="category">Tech/JavaScript</p>
                                    <p class="date">2021-09-11 15:17:27</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p data-ke-size="size16">API를 Lambda에 올려서 돌리고 있다.</p>
<p data-ke-size="size16">데이터가 6MB를 넘으면 Network Error가 나오는데...</p>
<p data-ke-size="size16">API에서 데이터를 압축해서 보낸 후, 화면쪽에서 압축 풀면 되지 않나?</p>
<p data-ke-size="size16">라는 생각에, 일단 시도해 보았다.</p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16">처음엔 <a href="https://stackoverflow.com/questions/62025368/what-is-a-good-away-to-compress-aws-lambda-response-to-avoid-6mb-limit" target="_blank" rel="noopener">이거</a>를 참조해서 gzip이라던가 써 봤는데...</p>
<p data-ke-size="size16">소스코드도 길어지고, 압축 푸는데 뻑나고 그러더라.</p>
<p data-ke-size="size16">그래서 그냥 <a href="https://www.npmjs.com/package/pako" target="_blank" rel="noopener">pako</a>를 사용해서 해결했다.</p>
<p data-ke-size="size16">&nbsp;</p>
<p data-ke-size="size16"><b>API (Lambda)</b></p>
<pre id="code_1631340379500" class="javascript" data-ke-language="javascript" data-ke-type="codeblock"><code>import pako from 'pako';

// Zip
const zippedData = pako.deflate(JSON.stringify(targetData));

result.status = RESPONSE_STATUS.OK;
result.response = {
  targetData: zippedData,
}

// 리스폰스 타입은 Uint8Array로 지정
export class ResponseBodyModel {
  @v.IsNotEmpty()
  status: number
  response: {
    targetData: Uint8Array,
  }
}</code></pre>
<p data-ke-size="size16"><b>UI</b></p>
<pre id="code_1631340770414" class="javascript" data-ke-language="javascript" data-ke-type="codeblock"><code>import sizeof from 'object-sizeof';
import pako from 'pako';

const onTableSearch = (option: SelectOption) =&gt; {
  // ...
  
  APIList.getTableData.get({
    searchKey: option.searchKey,
  }).then((res: TargetData) =&gt; {
    console.log("Size of zippedData(MB)", sizeof(res.targetData) / (1024 * 1024));

    const targetData = JSON.parse(pako.inflate(res.targetData, { to: 'string' }));
    console.log("Size of targetData(MB)", sizeof(targetData) / (1024 * 1024));
    setTableData(targetData);

}).catch((err) =&gt; {
    toast.error(err.message ? err.message : err);
    
  }).finally(() =&gt; {
    // ...
  });
};

// 리스폰스 타입은 Uint8Array로 설정
export type TargetData = {
  targetData: Uint8Array
};</code></pre>
<p data-ke-size="size16">결과는 대충 이런 식이다.</p>
<p><figure class="imageblock alignLeft" data-origin-width="350" data-origin-height="46" data-ke-mobilestyle="widthOrigin">
    <span data-lightbox="lightbox">
        <img src="./img/img.png" data-origin-width="350" data-origin-height="46" data-ke-mobilestyle="widthOrigin" />
    </span>
    <figcaption></figcaption>
</figure></p>
<p data-ke-size="size16">간당간당 6메가 안넘기고 해결.</p>
<p data-ke-size="size16">편하긴 한데, 압축률이 그다지 좋지 않은 것 같다.</p>
                        </div>
                        <br/>
                        <div class="tags">
                            #javascript #gzip #lambda #6mb #pako 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
