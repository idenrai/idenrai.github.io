
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>Azure AI Search 인덱스 검색 & 삭제</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">Azure AI Search 인덱스 검색 & 삭제</h2>
                                <div class="box-info">
                                    <p class="category">Tech/Azure</p>
                                    <p class="date">2024-06-14 11:54:25</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <h2>개요</h2>
<p>DynamoDB에서 30일 이상 경과한 데이터를 검색, 해당 데이터의 documentId를 통해 Azure AI Search Index에서 해당 데이터를 검색 및 삭제하는 스크립트</p>
<h2>상세</h2>
<h3>준비</h3>
<p>poetry를 사용하여 환경 구축</p>
<pre><code>poetry init
poetry add boto3 requests
poetry install
poetry shell</code></pre><h3>코드 본문</h3>
<h4>연결 정보</h4>
<pre><code class="language-python">import boto3
import requests
import json
from boto3.dynamodb.conditions import Key
from datetime import datetime, timedelta

# Dev
service_name = &quot;search-ai-dev&quot;
index_name = &quot;index-document&quot;
api_version = &quot;2024-05-01-Preview&quot;

# 검색용 쿼리 키
api_key = &quot;aaaaa&quot;

# 삭제용 기본 관리자 키
admin_key = &quot;bbbbb&quot;

# 여기서는 그냥 로컬 DynamoDB를 사용
dynamodb = boto3.resource(&#39;dynamodb&#39;, endpoint_url=&#39; http://localhost:8000&#39;) 

# 테이블 정의
document_table = dynamodb.Table(&#39;Document&#39;)

# 30일 이전 데이터를 구하기 위해 지정
days_ago = 30</code></pre>
<h4>DynamoDB에서 id 취득</h4>
<p>DynamoDB의 Document 테이블에서 id를 취득</p>
<pre><code class="language-python">target_date = (datetime.now() - timedelta(days=days_ago)).strftime(&#39;%Y-%m-%d&#39;)
response = document_table.scan(
    FilterExpression=Key(&#39;updated_at&#39;).lt(target_date)
)

id_list = [item[&#39;id&#39;] for item in response[&#39;Items&#39;]]</code></pre>
<h4>AI Search 인덱스 검색</h4>
<p>DynamoDB에서 얻은 <code>id_list</code>를 이용하여 AI Search에서 해당 <code>document_id</code>를 가지는 데이터를 검색.<br>AI Search에서 데이터를 삭제하려면 인덱스 키 (<code>&quot;key&quot;: true</code>로 설정된 필드)를 취득해야 하는데, <code>document_id</code>는 키가 아닌 관계로, <code>document_id</code>를 가지는 데이터를 검색, 해당 데이터의 <code>id</code>필드를 가져와야 했다.<br>또한, <code>document_id</code>는 <code>&quot;searchable&quot;: false</code>로 설정되어 있기 때문에,  <code>filter</code>로 검색했다.</p>
<pre><code class="language-python"># 검색용 URL
search_url = f&quot;https://{service_name}.search.windows.net/indexes/{index_name}/docs/search?api-version={api_version}&quot;

# 검색용 header
search_headers = {&quot;Content-Type&quot;: &quot;application/json&quot;, &quot;api-key&quot;: api_key}

index_keys = []
for id in id_list:
    payload = {
        &quot;count&quot;: True,
        &quot;filter&quot;: f&quot;document_id eq &#39;{id}&#39;&quot;,
    }
    response = requests.post(search_url, headers=search_headers, json=payload)

    if response.status_code == 200:
        documents = response.json()[&#39;value&#39;]
        for doc in documents:
            index_keys.append(doc[&#39;id&#39;])
    else:
        print(f&#39;Failed to search document with ID: {id}. Response: {response.text}&#39;)

print(index_keys)</code></pre>
<h4>AI Search 인덱스 데이터 삭제</h4>
<p>위에서 취득한 <code>index_keys</code>를 사용하여 해당 데이터를 삭제.<br>삭제시 주의할 점은 아래의 2가지.</p>
<ul>
<li>삭제시에는 쿼리 키가 아니라 관리자 키를 사용하여야 함</li>
<li>삭제시에는 url을 search가 아니라 index로 지정</li>
</ul>
<pre><code class="language-python"># 삭제용 URL
delete_url = f&quot;https://{service_name}.search.windows.net/indexes/{index_name}/docs/index?api-version={api_version}&quot;

# 삭제용 header
delete_headers = {&quot;Content-Type&quot;: &quot;application/json&quot;, &quot;api-key&quot;: admin_key}

for id in index_keys:
    data = {
        &quot;value&quot;: [
            {
                &quot;@search.action&quot;: &quot;delete&quot;,
                &quot;id&quot;: id
            }
        ]
    }
    response = requests.post(delete_url, headers=delete_headers, data=json.dumps(data))

    # 응답 확인
    if response.status_code == 200:
        print(f&#39;Successfully deleted document with ID: {id}&#39;)
    else:
        print(f&#39;Failed to delete document with ID: {id}. Response: {response.text}&#39;)</code></pre>
<p>이렇게 삭제할 수 있었다.</p>

                        </div>
                        <br/>
                        <div class="tags">
                            #search #delete #index #azure ai search 
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
