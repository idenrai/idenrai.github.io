
<meta charset="utf-8">
<html lang="ko">
<head>
    <link rel="stylesheet" type="text/css" href="./../style.css" />
    <title>Key-Break</title>
</head>
<body id="tt-body-page" class="">
<div id="wrap" class="wrap-right">
    <div id="container">
        <main class="main ">
            <div class="area-main">
                <div class="area-view">
                    <div class="article-header">
                        <div class="inner-article-header">
                            <div class="box-meta">
                                <h2 class="title-article">Key-Break</h2>
                                <div class="box-info">
                                    <p class="category">Tech/React.js</p>
                                    <p class="date">2017-04-27 10:01:05</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="article-view">
                        <div class="contents_style">
                            <p>@markdown</p><p><br /></p><p># Key-Break</p><p><br /></p><p>DB에서 습득하는 데이터를 그 내용에 따라 분류하여 출력하기</p><p><br /></p><p>- &nbsp; 데이터는 다음의 세 테이블 (Users, Authorities, User-Authority)에서 습득</p><p>- &nbsp; User는 복수의 Authority를 가질 수 있음.</p><p>&nbsp; &nbsp; - &nbsp; Authority가 복수인 유저의 경우, main key인 user.id가 중복됨</p><p>&nbsp; &nbsp; - &nbsp; 데이터를 출력할 테이블은 user.id를 key로 가지므로, id가 중복되는 경우 에러가 발생.</p><p>&nbsp; &nbsp; - &nbsp; 두 데이터를 하나로 합치고, 테이블에 표시되는 Auth에는 Authority.name을 ,로 연결하여 출력할 것. ex) "Admin, User"</p><p>- &nbsp; 각 User의 Authority 데이터는 다른 화면에서 사용되므로, 따로 Json Object로 만들어 Users State에 함께 보관할 것.</p><p><br /></p><p>### 데이터 습득</p><p><br /></p><p>```javascript</p><p>handleSearch = async () =&gt; {</p><p>&nbsp; const {</p><p>&nbsp; &nbsp; username,</p><p>&nbsp; } = this.state.search;</p><p><br /></p><p>&nbsp; let url = '';</p><p>&nbsp; if (username.length &gt; 0) {</p><p>&nbsp; &nbsp; url = `/api/users?username=${username}`;</p><p>&nbsp; } else {</p><p>&nbsp; &nbsp; url = '/api/users';</p><p>&nbsp; }</p><p>&nbsp; await this.axios.get(url)</p><p>&nbsp; .then((res) =&gt; {</p><p>&nbsp; &nbsp; this.createTable(res.data);</p><p>&nbsp; })</p><p>&nbsp; .catch((err) =&gt; {</p><p>&nbsp; &nbsp; this.notice(err.response.data.message, 'error');</p><p>&nbsp; &nbsp; return;</p><p>&nbsp; });</p><p>}</p><p>```</p><p><br /></p><p>### 데이터 정렬, 가공, 테이블 작성</p><p><br /></p><p>- &nbsp; 정렬 및 setState를 통해 테이블 출력</p><p><br /></p><p>```javascript</p><p>createTable = (data) =&gt; {</p><p>&nbsp; if (!data.length &gt; 0) this.notice(Message.validate.noData, 'warning');</p><p>&nbsp; data.sort((a, b) =&gt; {</p><p>&nbsp; &nbsp; const aValue = a.id;</p><p>&nbsp; &nbsp; const bValue = b.id;</p><p>&nbsp; &nbsp; if (aValue &amp;lt; bValue) return -1;</p><p>&nbsp; &nbsp; if (aValue &gt; bValue) return 1;</p><p>&nbsp; &nbsp; return 0;</p><p>&nbsp; });</p><p>&nbsp; const adjustedData = this.checkMultiAuth(data);</p><p>&nbsp; const tableData = this.makeTableData(adjustedData);</p><p>&nbsp; this.setState(</p><p>&nbsp; &nbsp; assign(this.state.tableData, { rows: tableData })</p><p>&nbsp; );</p><p>}</p><p>```</p><p><br /></p><p>- &nbsp; Key-Break 실시</p><p><br /></p><p>```javascript</p><p>checkMultiAuth = (rows) =&gt; {</p><p>&nbsp; const adjustedData = []; &nbsp;// 가공한 데이터 보존 및 Return</p><p>&nbsp; let stockId = null; &nbsp; &nbsp; &nbsp; // 이전 id 저장</p><p>&nbsp; let stockObject = null; &nbsp; // 이전 object 저장</p><p>&nbsp; let stockAuthObject = []; // authority object 저장</p><p><br /></p><p>&nbsp; rows.forEach((row, index) =&gt; {</p><p>&nbsp; &nbsp; // 첫 Row는 바로 Stock에 넣는다.</p><p>&nbsp; &nbsp; if (index === 0) {</p><p>&nbsp; &nbsp; &nbsp; stockId = row.id;</p><p>&nbsp; &nbsp; &nbsp; stockObject = row;</p><p>&nbsp; &nbsp; &nbsp; stockAuthObject.push({</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_id: row.authorities_id,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_authority: row.authorities_authority,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_name: row.authorities_name,</p><p>&nbsp; &nbsp; &nbsp; });</p><p>&nbsp; &nbsp; &nbsp; return;</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; // 2번째 row 이후부터는&nbsp;id가 중복되는지 분별</p><p>&nbsp; &nbsp; if (row.id === stockId) {</p><p>&nbsp; &nbsp; &nbsp; // row의 id가 이전과 동일할 경우, auth object를 추가하고 다음 row로</p><p>&nbsp; &nbsp; &nbsp; stockAuthObject.push({</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_id: row.authorities_id,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_authority: row.authorities_authority,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_name: row.authorities_name,</p><p>&nbsp; &nbsp; &nbsp; });</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; // id가 이전 row와 다를 경우, stock에 넣어 두었던 데이터를 전부 adjustedData에 저장</p><p>&nbsp; &nbsp; &nbsp; stockAuthObject.sort((a, b) =&gt; {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; const aValue = a.authorities_id;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; const bValue = b.authorities_id;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (aValue &lt; bValue) return -1;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (aValue &gt; bValue) return 1;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return 0;</p><p>&nbsp; &nbsp; &nbsp; });</p><p>&nbsp; &nbsp; &nbsp; assign(stockObject, { auths: stockAuthObject });</p><p>&nbsp; &nbsp; &nbsp; adjustedData.push(stockObject);</p><p><br /></p><p>&nbsp; &nbsp; &nbsp; // stock을 지금의 row로 재설정</p><p>&nbsp; &nbsp; &nbsp; stockAuthObject = [];</p><p>&nbsp; &nbsp; &nbsp; stockId = row.id;</p><p>&nbsp; &nbsp; &nbsp; stockObject = row;</p><p>&nbsp; &nbsp; &nbsp; stockAuthObject.push({</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_id: row.authorities_id,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_authority: row.authorities_authority,</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorities_name: row.authorities_name,</p><p>&nbsp; &nbsp; &nbsp; });</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; // 현재의 row가 마지막 row일 경우, stock을 전부 adjustedData에 저장하고 작업 종료</p><p>&nbsp; &nbsp; if (index === rows.length - 1) {</p><p>&nbsp; &nbsp; &nbsp; stockAuthObject.sort((a, b) =&gt; {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; const aValue = a.authorities_id;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; const bValue = b.authorities_id;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (aValue &lt; bValue) return -1;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (aValue &gt; bValue) return 1;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return 0;</p><p>&nbsp; &nbsp; &nbsp; });</p><p>&nbsp; &nbsp; &nbsp; assign(stockObject, { auths: stockAuthObject });</p><p>&nbsp; &nbsp; &nbsp; adjustedData.push(stockObject);</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; return;</p><p>&nbsp; });</p><p>&nbsp; return adjustedData;</p><p><br /></p><p>}</p><p>```</p><p><br /></p><p>- &nbsp; 각 row에 넣었던 auth object 내부 정렬 및 테이블 출력용 데이터 가공</p><p><br /></p><p>```javascript</p><p>makeTableData = (rows) =&gt; {</p><p>&nbsp; const tableData = [];</p><p>&nbsp; rows.forEach((row) =&gt; {</p><p>&nbsp; &nbsp; let authorityName = '';</p><p>&nbsp; &nbsp; if (row.auths.length &gt; 1) {</p><p>&nbsp; &nbsp; &nbsp; row.auths.forEach((auth, index) =&gt; {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; if (index &gt; 0) authorityName = `${authorityName}、`;</p><p>&nbsp; &nbsp; &nbsp; &nbsp; authorityName = `${authorityName}${auth.authorities_name}`;</p><p>&nbsp; &nbsp; &nbsp; });</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; authorityName = row.authorities_name;</p><p>&nbsp; &nbsp; }</p><p><br /></p><p>&nbsp; &nbsp; // 그외</p><p><br /></p><p>&nbsp; &nbsp; const lastAccountLockedTime = row.last_account_locked_time ?</p><p>&nbsp; &nbsp; &nbsp; moment(row.last_account_locked_time).format('YYYY-MM-DD HH:mm:ss') : row.last_account_locked_time;</p><p><br /></p><p>&nbsp; &nbsp; const newRow = {</p><p>&nbsp; &nbsp; &nbsp; id: row.id,</p><p>&nbsp; &nbsp; &nbsp; username: row.username,</p><p>&nbsp; &nbsp; &nbsp; authority: row.auths,</p><p>&nbsp; &nbsp; &nbsp; authorities_name: authorityName,</p><p><br /></p><p>&nbsp; &nbsp; // 그외</p><p><br /></p><p>&nbsp; &nbsp; &nbsp; last_account_locked_time: lastAccountLockedTime,</p><p>&nbsp; &nbsp; };</p><p>&nbsp; &nbsp; tableData.push(newRow);</p><p>&nbsp; });</p><p>&nbsp; return tableData;</p><p>}</p><p>```</p><div><br /></div><p><br /></p>
                        </div>
                        <br/>
                        <div class="tags">
                            
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
</body>
</html>
